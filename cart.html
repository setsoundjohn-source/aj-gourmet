<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panier ‚Äì AJ Gourmet</title>
  <meta name="description" content="Votre panier AJ Gourmet : produits, quantit√©s, total et estimation des frais de livraison." />
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/logo_C_emblem_dark_32.png">
  <style>
    :root{--bg:#0B0B0F;--fg:#F5F5F7;--gold:#CBA135;--muted:#9CA3AF;--line:rgba(255,255,255,.15);--card:rgba(255,255,255,.04)}
    *{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:var(--fg);text-decoration:none}
    .wrap{max-width:1100px;margin:32px auto;padding:0 20px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;position:sticky;top:0;background:rgba(11,11,15,.85);backdrop-filter:blur(8px);padding:12px 0;border-bottom:1px solid var(--line);z-index:10}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{font-weight:700;letter-spacing:.08em}
    nav{display:flex;gap:10px;align-items:center}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);padding:10px 14px;border-radius:12px;color:var(--fg);background:transparent;cursor:pointer}
    .btn:hover{background:rgba(255,255,255,.06)}
    .primary{background:var(--gold);border-color:var(--gold);color:#111}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:18px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    h1{margin:10px 0 8px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid var(--line)}
    th{text-align:left;font-weight:700}
    .muted{color:var(--muted)}
    .right{text-align:right}
    .qtybtn{min-width:34px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{border:1px solid var(--line);border-radius:999px;padding:7px 10px}
    .field{display:flex;flex-direction:column;gap:6px}
    input,select{background:transparent;border:1px solid var(--line);border-radius:10px;color:var(--fg);padding:10px}
    .rates{display:flex;flex-direction:column;gap:8px}
    .rate{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);border-radius:12px;padding:10px}
    .badge{display:inline-flex;align-items:center;gap:8px;background:rgba(203,161,53,.12);border:1px solid rgba(203,161,53,.35);color:var(--gold);padding:7px 10px;border-radius:999px;font-weight:700;font-size:.9rem}
    footer{margin:28px 0 10px;font-size:.95rem;opacity:.9}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <a href="/" class="btn">‚Üê Accueil</a>
        <div class="logo">AJ GOURMET</div>
      </div>
      <nav>
        <a class="btn" href="/#catalogue">Catalogue</a>
        <a class="btn" href="/contact.html">Contact</a>
        <a class="btn primary" href="/cart.html" aria-current="page">üõí Panier</a>
      </nav>
    </header>

    <h1>Votre panier</h1>
    <div class="grid">
      <!-- Panier -->
      <section class="card" id="cart-card" aria-label="Tableau panier">
        <div id="cart-box" class="muted">Chargement du panier‚Ä¶</div>
        <div class="row" style="margin-top:12px">
          <button id="cart-clear" class="btn">Vider</button>
          <span class="badge" id="cart-total">Total : 0,00 ‚Ç¨</span>
        </div>
      </section>

      <!-- Estimation / Paiement -->
      <section class="card" aria-label="Estimation livraison et paiement">
        <h2 style="margin-top:0">Estimation d‚Äôexp√©dition</h2>
        <div class="row" style="gap:12px">
          <div class="field" style="flex:1 1 130px">
            <label>Pays (code ISO)</label>
            <input id="country" placeholder="Ex: FR, US, BR">
          </div>
          <div class="field" style="flex:1 1 160px">
            <label>Code postal</label>
            <input id="postal" placeholder="Ex: 75008">
          </div>
          <div class="field" style="flex:1 1 120px">
            <label>Poids total (kg)</label>
            <input id="weight" type="number" step="0.1" value="1.5" title="Auto-rempli √† partir des articles du panier (modifiable)">
          <small class="muted" id="auto-weight-note" style="display:block"></small>
          </div>
          <div class="field" style="align-self:flex-end">
            <button id="quote" class="btn primary">Obtenir les tarifs</button>
          </div>
        </div>

        <div id="rates" class="rates" style="margin-top:12px">
          <div class="muted">Saisissez la destination puis cliquez sur ‚ÄúObtenir les tarifs‚Äù.</div>
        </div>

        <div class="row" style="margin-top:14px">
          <button id="checkout" class="btn">Payer (d√©mo Stripe)</button>
          <span class="muted">S√©lectionnez un tarif avant de payer (facultatif en mode d√©mo).</span>
        </div>
      </section>
    </div>

    <footer style="margin-top:24px">
      <a href="/mentions-legales.html">Mentions l√©gales</a> ¬∑
      <a href="/cgv.html">CGV</a> ¬∑
      <a href="/politique-confidentialite.html">Confidentialit√©</a> ¬∑
      <a href="/contact.html">Contact</a>
    </footer>
  </div>

  <script>
    /* ---------- PANIER ---------- */
    const CART_KEY = 'ajg_cart_v1';
    const money = n => Number(n||0).toFixed(2).replace('.', ',');
    /* ---------- TABLE DE POIDS PAR SKU (kg) ---------- */
/* Priorit√©: item.weight_kg > WEIGHT_BY_SKU[sku] > DEFAULT_ITEM_WEIGHT */
const DEFAULT_ITEM_WEIGHT = 0.5;

const WEIGHT_BY_SKU = {
  // --- Charcuterie & √©picerie (site-data)
  "SAL-NAT-250": 0.35,
  "SAL-TRUF-250": 0.35,
  "COND-MOUT-DIJ-200": 0.35,
  "CONF-FIG-250": 0.45,

  // --- Foie gras
  "FOG-ENT-180": 0.55,
  "FOG-BLOC-200": 0.40,

  // --- Caviar
  "CAV-BAE-30": 0.20,
  "CAV-OSC-50": 0.25,

  // --- Vins & spiritueux
  "VIN-BDX-R-075": 1.60,
  "VIN-CHMP-BRUT-075": 1.80,
  "SPI-COG-VSOP-070": 1.50,

  // --- Coffret
  "BOX-APERO-001": 1.80,

  // --- Multimedia (bo√Ætes + protections)
  "PHN-IPH-PRO-256": 0.60,
  "PHN-SAM-S-ULTRA-256": 0.62,
  "EAR-TWS-PREM": 0.25,
  "WATCH-PREM-45": 0.40,
  "TAB-11-256": 0.90,
  "LAP-14-PRO": 2.10,

  // --- Tes 3 boutons d'exemple (index.html)
  "FG125": 0.20,   // Foie gras 125g (approx)
  "CVR30": 0.20,   // Caviar 30g
  "BOR75": 1.60    // Bordeaux 75cl
};

/* Calcule le poids total (kg) du panier courant */
function computeCartWeight(items){
  return items.reduce((sum, it) => {
    const qty = Number(it.quantity || 1);
    const sku = (it.sku || '').trim();
    const fromItem = (typeof it.weight_kg === 'number') ? it.weight_kg : null;
    const fromTable = sku && WEIGHT_BY_SKU[sku] ? WEIGHT_BY_SKU[sku] : null;
    const w = (fromItem ?? fromTable ?? DEFAULT_ITEM_WEIGHT);
    return sum + qty * Number(w);
  }, 0);
}

/* Met √† jour le champ #weight et l‚Äôinfo ‚ÄúPoids auto‚Äù */
function updateWeightField(){
  const items = getCart();
  const totalKg = computeCartWeight(items);
  const inp = document.getElementById('weight');
  const note = document.getElementById('auto-weight-note');
  if (inp){
    // arrondi au 0.1 le plus proche
    const rounded = Math.max(0.1, Math.round(totalKg * 10) / 10);
    inp.value = rounded.toString();
  }
  if (note){
    note.textContent = `Poids auto estim√© : ${totalKg.toFixed(2)} kg (modifiable)`;
  }
}

    const getCart = () => {
      try { return JSON.parse(localStorage.getItem(CART_KEY) || '[]'); }
      catch { return []; }
    };
    const saveCart = items => localStorage.setItem(CART_KEY, JSON.stringify(items));

    function computeTotal(items){
      return items.reduce((s,i)=> s + (Number(i.amount_eur)||0) * (i.quantity||1), 0);
    }

    function renderCart(){
      const box = document.getElementById('cart-box');
      const totalBadge = document.getElementById('cart-total');
      const items = getCart();

      if (!items.length){
        box.innerHTML = 'Panier vide.';
        totalBadge.textContent = 'Total : 0,00 ‚Ç¨';
        return;
        updateWeightField();
      }

      const rows = items.map((i,idx)=>`
        <tr>
          <td>${i.title || i.sku || 'Article'}</td>
          <td class="right">
            <button class="btn qtybtn" data-qty="${idx}" data-delta="-1">-</button>
            <span style="display:inline-block;width:28px;text-align:center">${i.quantity||1}</span>
            <button class="btn qtybtn" data-qty="${idx}" data-delta="1">+</button>
          </td>
          <td class="right">${money(i.amount_eur)} ‚Ç¨</td>
          <td class="right"><button class="btn" data-del="${idx}">x</button></td>
        </tr>
      `).join('');

      box.innerHTML = `
        <table>
          <thead>
            <tr><th>Produit</th><th class="right">Qt√©</th><th class="right">Prix</th><th></th></tr>
          </thead>
          <tbody>${rows}</tbody>
          <tfoot>
            <tr><td></td><td class="right" colspan="2"><b>Total</b></td><td class="right"><b>${money(computeTotal(items))} ‚Ç¨</b></td></tr>
          </tfoot>
        </table>
      `;
      totalBadge.textContent = 'Total : ' + money(computeTotal(items)) + ' ‚Ç¨';
    }

    document.addEventListener('click', (e)=>{
      // supprimer
      const delIdx = e.target.getAttribute?.('data-del');
      if (delIdx !== null && delIdx !== undefined){
        const cart = getCart(); cart.splice(Number(delIdx),1); saveCart(cart); renderCart();
      }
      // quantit√©
      const qIdx = e.target.getAttribute?.('data-qty');
      if (qIdx !== null && qIdx !== undefined){
        const delta = Number(e.target.getAttribute('data-delta')||1);
        const cart = getCart();
        cart[qIdx].quantity = Math.max(1, (cart[qIdx].quantity||1) + delta);
        saveCart(cart); renderCart();
      }
    });

    document.getElementById('cart-clear')?.addEventListener('click', ()=>{
      saveCart([]); renderCart();
    });

    /* ---------- ESTIMATION LIVRAISON ---------- */
    const q = s => document.querySelector(s);
    function renderRatesList(out){
      const wrap = q('#rates');
      if (!wrap) return;
      if (!out || out.error){
        wrap.innerHTML = '<div class="muted">Erreur: ' + (out?.error || 'r√©ponse invalide') + '</div>';
        return;
      }
      const rates = Array.isArray(out.rates) ? out.rates : [];
      if (!rates.length){
        wrap.innerHTML = '<div class="muted">Aucun tarif retourn√© ('+(out.mode||'demo')+').</div>';
        return;
      }
      wrap.innerHTML = rates.map((r,idx)=>`
        <label class="rate">
          <span>${r.carrier} ‚Äî ${r.service||'service'} ${r.days? '('+r.days+' j)' : ''}</span>
          <span><b>${Number(r.price_eur).toFixed(2)} ‚Ç¨</b>
            <input type="radio" name="shiprate" value="${idx}" style="margin-left:8px"></span>
        </label>
      `).join('');
      // pr√©-s√©lection 1er
      const first = wrap.querySelector('input[name="shiprate"]'); if (first) first.checked = true;
    }

    q('#quote')?.addEventListener('click', async ()=>{
      const country = (q('#country')?.value || '').trim().toUpperCase();
      const postal  = (q('#postal')?.value  || '').trim();
      const weight  = Math.max(0.1, parseFloat(q('#weight')?.value || '1.5'));
      q('#rates').innerHTML = '<div class="muted">Calcul en cours‚Ä¶</div>';
      try{
        const res = await fetch('/api/rates', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ country, postal, weight_kg: weight })
        });
        const out = await res.json().catch(()=>null);
        renderRatesList(out || {error:'R√©ponse vide'});
        // on garde le dernier r√©sultat en m√©moire pour l‚Äôenvoyer au checkout
        window.__lastRates = out;
      }catch(e){
        q('#rates').innerHTML = '<div class="muted">Erreur r√©seau: '+e.message+'</div>';
      }
    });

    /* ---------- CHECKOUT ---------- */
    q('#checkout')?.addEventListener('click', async ()=>{
      const items = getCart();
      if (!items.length) return alert('Panier vide.');
      // r√©cup√®re le tarif choisi si dispo
      let selectedRate = null;
      const radios = document.querySelectorAll('input[name="shiprate"]');
      radios.forEach(r => { if (r.checked && window.__lastRates?.rates?.[r.value]) selectedRate = window.__lastRates.rates[r.value]; });

      try{
        const r = await fetch('/api/create-checkout', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ items, shipping_rate: selectedRate || null })
        });
        const out = await r.json();
        if (out.url) location.href = out.url;
        else alert(out.error || 'Paiement indisponible');
      }catch(e){
        alert('Erreur r√©seau: '+e.message);
      }
    });

    // init
    renderCart();
  </script>
</body>
</html>
